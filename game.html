<!DOCTYPE html>
<html>
<head>
	<title>asher game</title>
	<style type="text/css">
		body {
			margin: 0;
			overflow: hidden;
		}
		canvas {
			border: 10px solid black;
			width: calc(100vw - 20px);
			height: calc(100vh - 20px);

		}
	</style>
	<script type="module">
		let canvas = document.querySelector("canvas")
		let style = getComputedStyle(canvas)

		let width = parseInt(style.width)
		let height = parseInt(style.height)

		canvas.width = width * devicePixelRatio
		canvas.height = height * devicePixelRatio

		let ctx = canvas.getContext("2d")	
		ctx.scale(devicePixelRatio, devicePixelRatio)

		let snakeSize = 10

		let food = []
		createDots(25, width, height, 2, 30)

		//canvas.addEventListener("pointermove", handlePointerMove)

		function handlePointerMove(e) {
			ctx.beginPath()
			ctx.arc(
				/*x*/e.clientX,
				/*y*/e.clientY,
				/*radius*/snakeSize,
				/*startAngle*/0,
				/*endAngle*/2 * Math.PI
			)
			ctx.fillStyle = "black"
			ctx.fill()
		}

		window.addEventListener("keydown", handleKeyDown)
		
		let step = { x:0, y:0 }
		function handleKeyDown(e) {
			const stepSize = 3.5
			switch(e.code) {
				case "ArrowRight":
					step = { x:stepSize, y:0 }
					break;
				case "ArrowLeft":
					step = { x:-stepSize, y:0 }
					break;
				case "ArrowDown":
					step = { x:0, y:stepSize }
					break;
				case "ArrowUp":
					step = { x:0, y:-stepSize }
					break;
			}
		}

		requestAnimationFrame(handleAnimationFrame)

		let currentPosition = { x:snakeSize, y:snakeSize }
		let lastMoveTime = performance.now()
		let lastSnakePositions = [currentPosition]
		let currentSnakeLength = 1

		const stepTime = 16 /*ms*/

		function handleAnimationFrame() {
			ctx.clearRect(0, 0, width, height)

			let currentTime = performance.now()
			let deltaTime = currentTime - lastMoveTime
			if (deltaTime >= stepTime) {
				currentPosition.x = Math.max(
					Math.min(currentPosition.x + step.x, width - snakeSize),
					snakeSize
				)
				currentPosition.y = Math.max(
					Math.min(currentPosition.y + step.y, height - snakeSize),
					snakeSize
				)
				lastMoveTime = currentTime
				lastSnakePositions.push({x:currentPosition.x, y:currentPosition.y})

				if (lastSnakePositions.length > currentSnakeLength) {
					lastSnakePositions.shift()
				}

				// see if we hit any food
				for (let i = 0; i < food.length; i++) {
					if (doesIntersect(
						food[i].p, 
						food[i].r, 
						currentPosition, 
						snakeSize)
					) {
						let foodSize = food[i].r

						// eat the food
						food.splice(i, 1)

						increaseSnakeLength(foodSize)
					}
				}
			}


			// draw the food
			drawFood()

			// draw the snake
			drawSnake(lastSnakePositions)			

			requestAnimationFrame(handleAnimationFrame)
		}

		function drawFood() {
			for (let i = 0; i < food.length; i++) {
				drawDot(food[i].p, food[i].r, food[i].c)
			}
		}

		function drawSnake(snakePositions) {
			for (let position of snakePositions) {
				drawDot(position, /*radius*/snakeSize, /*color*/"black")
			}
		}

		function drawDot(position, radius, color) {
			ctx.beginPath()
			ctx.arc(
				position.x,
				position.y,
				radius,
				/*startAngle*/0,
				/*endAngle*/2 * Math.PI
			)
			ctx.fillStyle = color
			ctx.fill()
		}

		function createDots(count, maxX, maxY, minRadius, maxRadius) {
			while(count-- > 0) {
				let p = { x:Math.random() * maxX, y:Math.random() * maxY}
				let r = minRadius + Math.random() * (maxRadius - minRadius)

				let red = Math.floor(Math.random() * 256)
				let green = Math.floor(Math.random() * 256)
				let blue = Math.floor(Math.random() * 256)

				let c = `rgb(${red}, ${green}, ${blue})`
				food.push({p:p, r:r, c:c})
			}
		}

		function doesIntersect(p1, r1, p2, r2) {
			let deltaX = p2.x - p1.x
			let deltaY = p2.y - p1.y
			let distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY)

			if (r1 + r2 > distance) {
				return true
			}

			return false
		}

		function increaseSnakeLength(foodSize) {
			currentSnakeLength += Math.floor(foodSize)
		}

	</script>
</head>
<body>
	<canvas></canvas>
</body>
</html>